# Run on a schedule
trigger: none
pr: none

# schedules:
#   - cron: '0 10 * * 1-5' # 10AM UTC (2AM PDT) MON-FRI (VS Code Pre-release builds at 9PM PDT)
#     displayName: Nightly Pre-Release Schedule
#     always: false # only run if there are source code changes
#     branches:
#       include:
#         - main

resources:
  repositories:
    - repository: MicroBuildTemplate
      type: git
      name: 1ESPipelineTemplates/MicroBuildTemplate
      ref: refs/tags/release
variables:
  - name: SigningType
    value: 'real'
  - name: TeamName
    value: VSCode-autopep8

parameters:
  - name: publishExtension
    displayName: ðŸš€ Publish Extension
    type: boolean
    default: false

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    sdl:
      sourceAnalysisPool: VSEngSS-MicroBuild2022-1ES
    pool:
      name: AzurePipelines-EO
      image: 1ESPT-Ubuntu22.04
      os: linux

    customBuildTags:
      - ES365AIMigrationTooling
    stages:
      - stage: Build
        displayName: Build & Package Extension
        jobs:
          - job: Build
            displayName: Build Job
            pool:
            name: VSEngSS-MicroBuild2022-1ES # use windows for codesigning to make things easier https://dev.azure.com/devdiv/DevDiv/_wiki/wikis/DevDiv.wiki/650/MicroBuild-Signing
            os: windows
            steps:
              - task: NodeTool@0
                inputs:
                  versionSpec: '22.x'
                  checkLatest: false
                displayName: Select Node version

              - task: UsePythonVersion@0
                inputs:
                  versionSpec: '3.13'
                  addToPath: true
                  architecture: 'x64'
                displayName: Select Python version

              - script: npm ci
                displayName: Install NPM dependencies

              - script: python -m pip install -U pip
                displayName: Upgrade pip

              - script: python -m pip install wheel
                displayName: Install wheel

              - script: python -m pip install nox
                displayName: Install nox

              - script: python -m nox --session install_bundled_libs
                displayName: Install Python dependencies

              - script: python ./build/update_ext_version.py --for-publishing
                displayName: Update build number

              - script: npm run package
                displayName: Build extension
