# Run on a schedule
trigger: none
pr: none

# schedules:
#   - cron: '0 10 * * 1-5' # 10AM UTC (2AM PDT) MON-FRI (VS Code Pre-release builds at 9PM PDT)
#     displayName: Nightly Pre-Release Schedule
#     always: false # only run if there are source code changes
#     branches:
#       include:
#         - main

resources:
  repositories:
    - repository: MicroBuildTemplate
      type: git
      name: 1ESPipelineTemplates/MicroBuildTemplate
      ref: refs/tags/release
variables:
  - name: TeamName
    value: VSCode-autopep8
  # Artifact naming variables for signed outputs
  - name: VSIX_NAME
    value: autopep8.vsix
  - name: ARTIFACT_NAME_VSIX
    value: signed-vsix
  - name: ARTIFACT_NAME_SOURCE_MAPS_PKG
    value: source-maps
  - name: AUTOPEP8_MANIFEST_NAME
    value: extension.manifest
  - name: AUTOPEP8_SIGNATURE_NAME
    value: extension.signature.p7s

parameters:
  - name: publishExtension
    displayName: ðŸš€ Publish Extension
    type: boolean
    default: false

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    sdl:
      sourceAnalysisPool: VSEngSS-MicroBuild2022-1ES
      codeSignValidation:
        enabled: true
      sbom:
        enabled: false  # Disable global SBOM generation; we'll enable selectively per artifact output
    pool:
      name: AzurePipelines-EO
      os: windows

    customBuildTags:
      - ES365AIMigrationTooling
    stages:
      - stage: Build
        displayName: Build & Package Extension
        jobs:
          - job: Build
            displayName: Build Job
            pool:
              name: VSEngSS-MicroBuild2022-1ES # use windows for codesigning to make things easier https://dev.azure.com/devdiv/DevDiv/_wiki/wikis/DevDiv.wiki/650/MicroBuild-Signing
              os: windows
            templateContext:
              mb:
                signing:
                  enabled: true
                  signType: real
                  signWithProd: true
              outputs:
                - output: pipelineArtifact
                  displayName: 'Publish Drop Artifact'
                  targetPath: '$(Build.StagingDirectory)\\drop'
                  artifactName: drop
                  sbomEnabled: true
            steps:
              - task: NodeTool@0
                inputs:
                  versionSpec: '20.x'
                  checkLatest: true
                displayName: Select Node 20 LTS

              - task: UsePythonVersion@0
                inputs:
                  versionSpec: '3.13'
                  addToPath: true
                  architecture: 'x64'
                displayName: Select Python version

              - script: npm ci
                displayName: Install NPM dependencies

              - script: python -m pip install -U pip
                displayName: Upgrade pip

              - script: python -m pip install wheel
                displayName: Install wheel

              - script: python -m pip install nox
                displayName: Install nox

              - script: python -m nox --session install_bundled_libs
                displayName: Install Python dependencies

              - script: python ./build/update_ext_version.py --for-publishing
                displayName: Update build number

              - script: npm run package
                displayName: Build extension

              - script: npx @vscode/vsce@latest package -o $(Build.StagingDirectory)/drop/autopep8.vsix
                displayName: Package VSIX

              - powershell: |
                  if (Test-Path autopep8.vsix) {
                    Write-Host 'VSIX generated successfully:'
                    Get-Item autopep8.vsix | Format-Table Name,Length,LastWriteTime -AutoSize
                  } else {
                    Write-Error 'VSIX was not generated.'
                    exit 1
                  }
                displayName: Verify VSIX generated

              - powershell: |
                  New-Item -ItemType Directory -Path "$(Build.StagingDirectory)\drop" -Force | Out-Null
                  Write-Host "Drop folder ensured."
                  Write-Host "Contents after packaging:"
                  Get-ChildItem -Recurse "$(Build.StagingDirectory)\drop" | Select FullName,Length | Format-Table -AutoSize
                displayName: Prep artifact directory

              # Conditionally sign within the same Build job (no separate stage)
              - ${{ if eq(parameters.publishExtension, true) }}:
                - powershell: |
                    Write-Host 'Signing is enabled (publishExtension=true). Proceeding to run sign template.'
                    Write-Host 'Contents of drop before signing:'
                    Get-ChildItem -Recurse "$(Build.StagingDirectory)\drop" | Select-Object FullName,Length | Format-Table -AutoSize
                  displayName: Pre-sign inspection
                - template: build/templates/sign.yml@self
                  parameters:
                    vsixName: $(VSIX_NAME)
                    workingDirectory: $(Build.SourcesDirectory)
                    signType: real
                - powershell: |
                    # Generate manifest & signature into drop (rather than root)
                    $drop = "$(Build.StagingDirectory)\drop"
                    $vsix = Join-Path $drop "autopep8.vsix"
                    if (!(Test-Path $vsix)) { Write-Error "VSIX missing for manifest generation: $vsix"; exit 1 }
                    Write-Host "Generating manifest from VSIX..."
                    npx @vscode/vsce@latest generate-manifest -i $vsix -o (Join-Path $drop "extension.manifest")
                    if ($LASTEXITCODE -ne 0) { Write-Error "Manifest generation failed"; exit 1 }
                    Copy-Item (Join-Path $drop "extension.manifest") (Join-Path $drop "extension.signature.p7s") -Force
                    Write-Host "Prepared signature placeholder."
                  displayName: Generate manifest & placeholder signature (drop)

                # (MicroBuild signing still signs root copy; ensure we sync final signed file into drop)
                - powershell: |
                    $rootSig = "$(Build.SourcesDirectory)\extension.signature.p7s"
                    $dropSig = "$(Build.StagingDirectory)\drop\extension.signature.p7s"
                    if (Test-Path $rootSig) {
                      Copy-Item $rootSig $dropSig -Force
                      Write-Host "Copied signed signature back into drop."
                    } else {
                      Write-Error "Missing signed signature at root: $rootSig"
                      exit 1
                    }
                    Get-ChildItem "$(Build.StagingDirectory)\drop" | Select Name,Length | Format-Table -AutoSize
                  displayName: Sync signed signature into drop
                - powershell: |
                    Write-Host 'Contents of drop after signing:'
                    Get-ChildItem -Recurse "$(Build.StagingDirectory)\drop" | Select-Object FullName,Length | Format-Table -AutoSize
                  displayName: Post-sign inspection
                - powershell: |
                    $vsix       = "$(Build.StagingDirectory)\drop\autopep8.vsix"
                    $manifest   = "$(Build.StagingDirectory)\drop\extension.manifest"
                    $signature  = "$(Build.StagingDirectory)\drop\extension.signature.p7s"
                    $log        = "$(Build.StagingDirectory)\drop\signature-verification.log"
                    Write-Host "Verifying signature:"
                    Write-Host "  VSIX:       $vsix"
                    Write-Host "  Manifest:   $manifest"
                    Write-Host "  Signature:  $signature"
                    if (!(Test-Path $vsix)) { Write-Error "Missing VSIX: $vsix"; exit 1 }
                    if (!(Test-Path $manifest)) { Write-Error "Missing manifest: $manifest"; exit 1 }
                    if (!(Test-Path $signature)) { Write-Error "Missing signature file: $signature"; exit 1 }
                    npx @vscode/vsce@latest verify-signature --packagePath "$vsix" --manifestPath "$manifest" --signaturePath "$signature" 2>&1 | Tee-Object -FilePath $log
                    if ($LASTEXITCODE -ne 0) {
                      Write-Error "vsce verify-signature failed (exit $LASTEXITCODE). See $log"
                      exit $LASTEXITCODE
                    }
                    Write-Host "vsce verify-signature succeeded âœ… (log: $log)"
                  displayName: Verify VSIX signature (drop paths)
                - powershell: |
                    $src = "$(Build.SourcesDirectory)"
                    $dist = Join-Path $src 'dist'
                    Write-Host "Listing signature-related files:"
                    $rootManifest = Join-Path $src 'extension.manifest'
                    $rootSignature = Join-Path $src 'extension.signature.p7s'
                    $distSignature = Join-Path $dist 'extension.signature.p7s'
                    Get-Item $rootManifest,$rootSignature,$distSignature -ErrorAction SilentlyContinue | `
                      Select-Object FullName,Length,LastWriteTime | Format-Table -AutoSize
                    if ((Test-Path $rootSignature) -and (Test-Path $distSignature)) {
                      $rootHash = (Get-FileHash $rootSignature -Algorithm SHA256).Hash
                      $distHash = (Get-FileHash $distSignature -Algorithm SHA256).Hash
                      Write-Host "Root signature hash: $rootHash"
                      Write-Host "Dist signature hash: $distHash"
                      if ($rootHash -eq $distHash) {
                        Write-Host "Hashes match (expected)."
                      } else {
                        Write-Warning "Hashes differ (unexpected)."
                      }
                    } else {
                      Write-Warning "One or both signature files missing; signing may have failed."
                    }
                  displayName: Inspect dist and root signature files

