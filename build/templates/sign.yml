# Template: Sign and validate VS Code extension artifacts
# Usage Example:
# - template: build/templates/sign.yml@self
#   parameters:
#     vsixName: autopep8.vsix
#     workingDirectory: $(Build.SourcesDirectory)
#     signType: real

parameters:
  - name: vsixName
    type: string
    default: autopep8.vsix
  - name: workingDirectory
    type: string
    default: '$(Build.SourcesDirectory)'
  - name: signType
    type: string
    default: real
  - name: verifySignature
    type: boolean
    default: true

steps:
  - script: |
      npm install -g @vscode/vsce
      echo "vsce version:"
      vsce --version
    displayName: Install & show vsce CLI

  - task: NuGetToolInstaller@1
    displayName: Install NuGet

  - task: NuGetCommand@2
    displayName: Restore signing packages
    inputs:
      command: restore
      restoreSolution: '$(Build.SourcesDirectory)/packages.config'
      restoreDirectory: '$(Build.SourcesDirectory)/packages'

  - task: PowerShell@2
    displayName: Pre-sign inspection
    inputs:
      targetType: inline
      script: |
        $wd = "${{ parameters.workingDirectory }}"
        Write-Host "Pre-sign contents of working directory: $wd"
        Get-ChildItem -Recurse $wd | Select-Object FullName,Length | Format-Table -AutoSize
        $vsix = Join-Path $wd "${{ parameters.vsixName }}"
        if (!(Test-Path $vsix)) { Write-Error "VSIX missing: $vsix"; exit 1 }
        $manifest = Join-Path $wd 'extension.manifest'
        if (!(Test-Path $manifest)) { Write-Error "Manifest missing: $manifest"; exit 1 }
        $sig = Join-Path $wd 'extension.signature.p7s'
        if (!(Test-Path $sig)) { Write-Warning "Signature placeholder missing (will attempt signing anyway)." }

  - task: MSBuild@1
    displayName: Run signing (MSBuild)
    inputs:
      solution: '$(Build.SourcesDirectory)/sign.proj'
      msbuildArguments: '/verbosity:minimal /p:SignType=${{ parameters.signType }}'

  - task: PowerShell@2
    displayName: Post-sign inspection
    inputs:
      targetType: inline
      script: |
        $wd = "${{ parameters.workingDirectory }}"
        Write-Host "Post-sign file listing:"
        Get-ChildItem $wd -File | Select-Object Name,Length | Format-Table -AutoSize
        $sig = Join-Path $wd 'extension.signature.p7s'
        if (Test-Path $sig) {
          Write-Host "Signature file present: $sig"
        } else {
          Write-Warning "Signature file NOT present after signing step."; exit 0
        }

  - ${{ if eq(parameters.verifySignature, true) }}:
    - task: PowerShell@2
      displayName: Verify VSIX signature
      inputs:
        targetType: inline
        script: |
          $wd = "${{ parameters.workingDirectory }}"
          $vsix       = Join-Path $wd "${{ parameters.vsixName }}"
          $manifest   = Join-Path $wd 'extension.manifest'
          $signature  = Join-Path $wd 'extension.signature.p7s'
          Write-Host "Verifying signature:"
          Write-Host "  packagePath  : $vsix"
          Write-Host "  manifestPath : $manifest"
          Write-Host "  signaturePath: $signature"
          if (!(Test-Path $vsix)) { Write-Error "Missing VSIX: $vsix"; exit 1 }
          if (!(Test-Path $manifest)) { Write-Error "Missing manifest: $manifest"; exit 1 }
          if (!(Test-Path $signature)) { Write-Error "Missing signature file: $signature"; exit 1 }
          npx @vscode/vsce@latest verify-signature --packagePath "$vsix" --manifestPath "$manifest" --signaturePath "$signature"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "vsce verify-signature failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          } else {
            Write-Host "vsce verify-signature succeeded âœ…"
          }
